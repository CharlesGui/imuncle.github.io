<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
    <title>GitHub issue测试</title>
    <script src="js/jquery.min.js"></script>
  </head>
  <body>
    <a href="https://github.com/login/oauth/authorize?client_id=22aaa014a31e292cfe21&scope=public_repo" target="_blank">登录</a>
    <br>
    code<input id="code"><button onclick="get_access_token()">获取access_token</button>
    <br>
    access_token<input id="access_token"><button onclick="get_user_info()">获取用户信息</button>
    <br>
    <input id="input"><button onclick="update()">提交</button>
    <p id="content"></p>
    <div id="comments"></div>
  </body>
  <script>
  var client_id = '22aaa014a31e292cfe21';
  var client_secret = '7ba1b3718986fba62fdceb47c0a2f23a1adf0c1b';
  //通过createXHR()函数创建一个XHR对象：
function createXHR() {
    if (window.XMLHttpRequest) {    //IE7+、Firefox、Opera、Chrome 和Safari
         return new XMLHttpRequest();
    } else if (window.ActiveXObject) {   //IE6 及以下
        var versions = ['MSXML2.XMLHttp','Microsoft.XMLHTTP'];
        for (var i = 0,len = versions.length; i<len; i++) {
            try {
                return new ActiveXObject(version[i]);
                break;
            } catch (e) {
                //跳过
            }  
        }
    } else {
        throw new Error('浏览器不支持XHR对象！');
    }
}
//封装ajax，参数为一个对象
function ajax(obj) {
    var xhr = createXHR();  //创建XHR对象
    //通过使用JS随机字符串解决IE浏览器第二次默认获取缓存的问题
    //obj.url = obj.url + '?rand=' + Math.random();
    obj.data = params(obj.data);  //通过params()将名值对转换成字符串
    //若是GET请求，则将数据加到url后面
    if (obj.method === 'get') {
        obj.url += obj.url.indexOf('?') == -1 ? '?' + obj.data : '&' + obj.data;
    }
    if (obj.async === true) {   //true表示异步，false表示同步
        //使用异步调用的时候，需要触发readystatechange 事件
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {   //判断对象的状态是否交互完成
                callback();      //回调
            }
        };
    }
    //在使用XHR对象时，必须先调用open()方法，
    //它接受三个参数：请求类型(get、post)、请求的URL和表示是否异步。
    xhr.open(obj.method, obj.url, obj.async);
    if (obj.method === 'post') {
        //post方式需要自己设置http的请求头，来模仿表单提交。
        //放在open方法之后，send方法之前。
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.send(obj.data);     //post方式将数据放在send()方法里
    } else {
        xhr.send(null);     //get方式则填null
    }
    if (obj.async === false) {  //同步
        callback();
    }
    function callback() {
        if (xhr.status == 200) {  //判断http的交互是否成功，200表示成功
            obj.success(xhr.responseText);          //回调传递参数
        } else {
            alert('获取数据错误！错误代号：' + xhr.status + '，错误信息：' + xhr.statusText);
        }  
    }
}
//名值对转换为字符串
function params(data) {
    var arr = [];
    for (var i in data) {
        //特殊字符传参产生的问题可以使用encodeURIComponent()进行编码处理
        arr.push(encodeURIComponent(i) + '=' + encodeURIComponent(data[i]));
    }
    return arr.join('&');
}
ajax({
    method : 'get',
    url : 'https://api.github.com/repos/imuncle/imuncle.github.io/issues/1/comments',
    data : {
        name : 'callback',
        pwd:'json'
    },
    success : function (message) {
        document.getElementById('content').innerHTML = message;
    },
    async : true
});

function update() {
  var input = document.getElementById('input').value;
  var access_token = document.getElementById('access_token').value;
  $.ajax({
    type: "post",
    url:"https://api.github.com/repos/imuncle/imuncle.github.io/issues/1/comments",
    headers: {
      Authorization : 'token '+ access_token,
      Accept: 'application/vnd.github.squirrel-girl-preview, application/vnd.github.html+json',
      'Content-Type': 'application/json'
    },
    data : JSON.stringify({
      "body" : input
    }),
    dataType: "json",
    success: function (data) {
      alert(data);
    }
  });
}

function showData(data) {
  console.log("showData");
}

function get_access_token() {
  var code = document.getElementById('code').value;
  $.ajax({
    type: "post",
    dataType:"jsonp",
    jsonp : "callback",
    jsonpCallback:"test",
    headers : {
      'Accept': 'application/json',
      'Content-Type': 'application/json; charset=UTF-8'
    },
    url:"https://github.com/login/oauth/access_token?client_id="+client_id+"&client_secret="+client_secret+"&code="+code,
    data : {
      //"client_id" : client_id,
      //"client_secret" : client_secret,
      //"code" : code
    },
    success: function (data) {
      //console.log(data);
      alert(1);
      data;
    }
  });
}

function test(response) {
  console.log(response);
}

function get_user_info() {
  var access_token = document.getElementById('access_token').value;
  ajax({
    method : 'get',
    url : 'https://api.github.com/user?access_token='+access_token,
    data : {
      
    },
    success : function (message) {
      alert(message);
    },
    async : true
  });
}
  </script>
</html>